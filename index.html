<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>indexpage</title>   
    <link rel="stylesheet" href="test.css">
    
    <!-- Firebase SDKã¯headå†…ã§å…ˆã«èª­ã¿è¾¼ã‚€ -->
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>åé ­ç—›è¨˜éŒ²</h1>

    <div class="calendar-header" id="calendarHeader">
        <button class="arrow-btn" id="prevMonthBtn">&#8592;</button>
        <span class="calendar-title" id="calendarTitle"></span>
        <button class="arrow-btn" id="nextMonthBtn">&#8594;</button>
    </div>
    <div id="calendar"></div>
   

    <!-- å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ -->
    <a href="write.html" class="plus-btn" title="æ–°è¦ä½œæˆ">ï¼‹</a>

    <!-- å·¦ä¸‹ã®ãƒ¡ãƒ¢ãƒœã‚¿ãƒ³ -->
    <a href="memo.html" class="memo-btn" title="ãƒ¡ãƒ¢ãƒšãƒ¼ã‚¸">ğŸ“</a>

    <!-- æ­¯è»Šãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šå›ºå®šï¼‰ -->
    <a href="setting.html" class="setting-btn" title="è¨­å®š">
        <span style="font-size:2em;">&#9881;</span>
    </a>

    <!-- ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
    <button id="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  
    <script>
    // Firebaseã®è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyBHlw82RbUfenDnDyM5WOnrEJqHHYwqQS4",
        authDomain: "headachereporttest.firebaseapp.com",
        projectId: "headachereporttest",
        storageBucket: "headachereporttest.appspot.com",
        messagingSenderId: "1011198068393",
        appId: "1:1011198068393:web:fa25a80f678c78f1764bb8",
        measurementId: "YOUR_MEASUREMENT_ID"
    };

    // Firebaseã‚’åˆæœŸåŒ–
    if (firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // UIéƒ¨å“å–å¾—
    const calendarDiv = document.getElementById('calendar');
    const calendarTitle = document.getElementById('calendarTitle');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const calendarHeader = document.getElementById('calendarHeader');
    
    let currentYear, currentMonth;

    // ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ»ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
    document.getElementById('loginBtn').onclick = function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    };

    document.getElementById('logoutBtn').onclick = function() {
        auth.signOut();
    };

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    function updateCalendarTitle(year, month) {
        calendarTitle.textContent = `${year}å¹´ ${month}æœˆ`;
    }

    async function createCalendar(year, month) {
        updateCalendarTitle(year, month);
        const firstDay = new Date(year, month - 1, 1).getDay();
        const lastDate = new Date(year, month, 0).getDate();

        // Firestoreã‹ã‚‰å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’å–å¾—
        const start = `${year}-${String(month).padStart(2, '0')}-01`;
        const end = `${year}-${String(month).padStart(2, '0')}-31`;
        let recordDates = [];
        if (window.userId) {
            const snapshot = await db.collection('records')
                .doc(window.userId)
                .collection('dates')
                .where(firebase.firestore.FieldPath.documentId(), '>=', start)
                .where(firebase.firestore.FieldPath.documentId(), '<=', end)
                .get();
            recordDates = snapshot.docs.map(doc => doc.id);
        }

        let html = '<table><thead><tr>';
        const week = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
        for(let d of week) html += `<th>${d}</th>`;
        html += '</tr></thead><tbody><tr>';

        for(let i = 0; i < firstDay; i++) html += '<td></td>';
        for(let date = 1; date <= lastDate; date++) {
            if((firstDay + date - 1) % 7 === 0 && date !== 1) html += '</tr><tr>';
            const ymd = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
            const hasRecord = recordDates.includes(ymd);
            // hasRecordãŒtrueãªã‚‰ã‚¯ã‚¨ãƒªã«hasRecord=1ã‚’è¿½åŠ 
            const query = hasRecord ? `?date=${encodeURIComponent(ymd)}&hasRecord=1` : `?date=${encodeURIComponent(ymd)}`;
            html += `<td>
                <a href="write.html${query}" class="calendar-link${hasRecord ? ' has-record' : ''}" data-date="${ymd}" data-has-record="${hasRecord}">
                    ${date}
                </a>
            </td>`;
        }
        const remaining = (firstDay + lastDate) % 7;
        if(remaining !== 0) for(let i = 0; i < 7 - remaining; i++) html += '<td></td>';
        html += '</tr></tbody></table>';
        calendarDiv.innerHTML = html;

        // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll('.calendar-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const date = this.getAttribute('data-date');
                if (!window.userId) return;
                // ç·¨é›†ç”»é¢(write.html)ã«æ—¥ä»˜ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã—ã¦é·ç§»
                window.location.href = `write.html?date=${encodeURIComponent(date)}`;
            });
        });
    }

    function showCalendar(year, month) {
        currentYear = year;
        currentMonth = month;
        createCalendar(year, month);
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœˆé€ã‚Šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    prevMonthBtn.onclick = function() {
        let y = currentYear;
        let m = currentMonth - 1;
        if (m < 1) {
            y--;
            m = 12;
        }
        showCalendar(y, m);
    };
    nextMonthBtn.onclick = function() {
        let y = currentYear;
        let m = currentMonth + 1;
        if (m > 12) {
            y++;
            m = 1;
        }
        showCalendar(y, m);
    };

    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = '';
            calendarHeader.classList.remove('hidden');
            calendarDiv.classList.remove('hidden');
            window.userId = user.uid;
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸè¡¨ç¤º
            const now = new Date();
            showCalendar(now.getFullYear(), now.getMonth() + 1);
        } else {
            document.getElementById('loginBtn').style.display = '';
            document.getElementById('logoutBtn').style.display = 'none';
            calendarHeader.classList.add('hidden');
            calendarDiv.classList.add('hidden');
        }
    });
    </script>
</body>
</html>